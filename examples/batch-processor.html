<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEGL.wasm Batch Processor Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .file-input {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .file-input:hover {
            border-color: #666;
        }
        .file-input.dragover {
            border-color: #4CAF50;
            background-color: #f9f9f9;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.cancel {
            background-color: #f44336;
        }
        button.cancel:hover {
            background-color: #d32f2f;
        }
        .progress {
            width: 100%;
            height: 24px;
            background-color: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background: white;
        }
        .image-item canvas {
            width: 100%;
            height: auto;
            display: block;
        }
        .image-info {
            padding: 8px;
            font-size: 12px;
            color: #666;
        }
        .image-status {
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
        }
        .image-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .image-status.processing {
            background-color: #cce5ff;
            color: #004085;
        }
        .image-status.completed {
            background-color: #d4edda;
            color: #155724;
        }
        .image-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GEGL.wasm Batch Processor Demo</h1>

        <div class="info">
            <strong>Instructions:</strong> Upload multiple image files to apply batch processing with blur effects.
            Images are processed using Web Workers for efficient, non-blocking operations with progress reporting.
        </div>

        <div class="file-input" id="fileInput">
            <div>Click to select multiple images or drag and drop here</div>
            <input type="file" id="fileUpload" accept="image/*" multiple style="display: none;">
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="totalImages">0</div>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="processedImages">0</div>
                <div class="stat-label">Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">Success</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>

        <div class="controls">
            <button id="processBtn" disabled>Start Batch Processing</button>
            <button id="cancelBtn" disabled class="cancel">Cancel</button>
            <button id="clearBtn" disabled>Clear All</button>
        </div>

        <div class="status" id="status">Ready to load images</div>
        <div class="progress" id="progress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="image-grid" id="imageGrid"></div>
    </div>

    <!-- Load GEGL.wasm JavaScript bindings -->
    <script src="../dist/gegl-wasm.umd.min.js"></script>

    <script>
        class BatchProcessor {
            constructor() {
                this.worker = null;
                this.images = [];
                this.isProcessing = false;
                this.currentIndex = 0;
                this.stats = {
                    total: 0,
                    processed: 0,
                    success: 0,
                    error: 0
                };

                this.fileInput = document.getElementById('fileInput');
                this.fileUpload = document.getElementById('fileUpload');
                this.processBtn = document.getElementById('processBtn');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.progress = document.getElementById('progress');
                this.progressBar = document.getElementById('progressBar');
                this.imageGrid = document.getElementById('imageGrid');
                this.statsContainer = document.getElementById('stats');

                this.init();
            }

            async init() {
                try {
                    this.updateStatus('Initializing Web Worker...');

                    // Create Web Worker for processing
                    this.worker = new Worker('batch-processor-worker.js');

                    this.worker.onmessage = (event) => {
                        this.handleWorkerMessage(event);
                    };

                    this.worker.onerror = (error) => {
                        console.error('Worker error:', error);
                        this.updateStatus('Worker error occurred. Check console for details.');
                    };

                    this.updateStatus('Web Worker initialized successfully!');
                    this.setupEventListeners();

                } catch (error) {
                    console.error('Failed to initialize worker:', error);
                    this.updateStatus('Failed to initialize Web Worker. Check console for details.');
                }
            }

            setupEventListeners() {
                // File input click
                this.fileInput.addEventListener('click', () => {
                    this.fileUpload.click();
                });

                // File selection
                this.fileUpload.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        this.loadImages(files);
                    }
                });

                // Drag and drop
                this.fileInput.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.fileInput.classList.add('dragover');
                });

                this.fileInput.addEventListener('dragleave', () => {
                    this.fileInput.classList.remove('dragover');
                });

                this.fileInput.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.fileInput.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    if (files.length > 0) {
                        this.loadImages(files);
                    }
                });

                // Process button
                this.processBtn.addEventListener('click', () => {
                    this.startBatchProcessing();
                });

                // Cancel button
                this.cancelBtn.addEventListener('click', () => {
                    this.cancelProcessing();
                });

                // Clear button
                this.clearBtn.addEventListener('click', () => {
                    this.clearAll();
                });
            }

            async loadImages(files) {
                try {
                    this.updateStatus(`Loading ${files.length} images...`);

                    for (const file of files) {
                        const imageItem = this.createImageItem(file);
                        this.images.push(imageItem);
                        this.imageGrid.appendChild(imageItem.element);
                    }

                    this.updateStats();
                    this.statsContainer.style.display = 'flex';
                    this.processBtn.disabled = false;
                    this.clearBtn.disabled = false;

                    this.updateStatus(`${files.length} images loaded successfully! Click "Start Batch Processing" to begin.`);

                } catch (error) {
                    console.error('Failed to load images:', error);
                    this.updateStatus('Failed to load some images. Check console for details.');
                }
            }

            createImageItem(file) {
                const element = document.createElement('div');
                element.className = 'image-item';

                const canvas = document.createElement('canvas');
                const info = document.createElement('div');
                info.className = 'image-info';

                const status = document.createElement('div');
                status.className = 'image-status pending';
                status.textContent = 'Pending';

                info.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                element.appendChild(canvas);
                element.appendChild(info);
                element.appendChild(status);

                return {
                    file,
                    element,
                    canvas,
                    status,
                    imageData: null,
                    processedData: null,
                    state: 'pending'
                };
            }

            async startBatchProcessing() {
                if (this.images.length === 0 || this.isProcessing) return;

                this.isProcessing = true;
                this.currentIndex = 0;
                this.stats.processed = 0;
                this.stats.success = 0;
                this.stats.error = 0;

                this.processBtn.disabled = true;
                this.cancelBtn.disabled = false;
                this.progress.style.display = 'block';
                this.updateOverallProgress(0);

                this.updateStatus('Starting batch processing...');

                try {
                    await this.processNextImage();
                } catch (error) {
                    console.error('Batch processing failed:', error);
                    this.updateStatus('Batch processing failed. Check console for details.');
                    this.finishProcessing();
                }
            }

            async processNextImage() {
                if (this.currentIndex >= this.images.length || !this.isProcessing) {
                    this.finishProcessing();
                    return;
                }

                const imageItem = this.images[this.currentIndex];
                imageItem.state = 'processing';
                imageItem.status.textContent = 'Processing...';
                imageItem.status.className = 'image-status processing';

                try {
                    // Load image if not already loaded
                    if (!imageItem.imageData) {
                        await this.loadImageData(imageItem);
                    }

                    // Send to worker for processing
                    this.worker.postMessage({
                        type: 'process',
                        imageData: imageItem.imageData,
                        operations: [{
                            operation: 'gegl:blur-gaussian',
                            properties: {
                                std_dev_x: 5.0,
                                std_dev_y: 5.0
                            }
                        }]
                    });

                } catch (error) {
                    console.error(`Failed to process ${imageItem.file.name}:`, error);
                    imageItem.state = 'error';
                    imageItem.status.textContent = 'Error';
                    imageItem.status.className = 'image-status error';
                    this.stats.error++;
                    this.stats.processed++;
                    this.updateStats();
                    this.updateOverallProgress((this.stats.processed / this.stats.total) * 100);
                    this.currentIndex++;
                    setTimeout(() => this.processNextImage(), 100);
                }
            }

            handleWorkerMessage(event) {
                const { type, processedData, error } = event.data;

                if (type === 'result') {
                    const imageItem = this.images[this.currentIndex];

                    // Display processed image
                    this.displayImageData(imageItem.canvas, processedData);

                    imageItem.processedData = processedData;
                    imageItem.state = 'completed';
                    imageItem.status.textContent = 'Completed';
                    imageItem.status.className = 'image-status completed';

                    this.stats.success++;
                    this.stats.processed++;
                    this.updateStats();
                    this.updateOverallProgress((this.stats.processed / this.stats.total) * 100);

                    this.currentIndex++;
                    setTimeout(() => this.processNextImage(), 100);

                } else if (type === 'error') {
                    const imageItem = this.images[this.currentIndex];
                    console.error(`Worker error for ${imageItem.file.name}:`, error);
                    imageItem.state = 'error';
                    imageItem.status.textContent = 'Error';
                    imageItem.status.className = 'image-status error';
                    this.stats.error++;
                    this.stats.processed++;
                    this.updateStats();
                    this.updateOverallProgress((this.stats.processed / this.stats.total) * 100);
                    this.currentIndex++;
                    setTimeout(() => this.processNextImage(), 100);
                }
            }

            async loadImageData(imageItem) {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = URL.createObjectURL(imageItem.file);
                });

                // Set canvas size to image size
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw image to canvas
                ctx.drawImage(img, 0, 0);

                // Get image data
                imageItem.imageData = ctx.getImageData(0, 0, img.width, img.height);

                // Display original on canvas
                this.displayImageData(imageItem.canvas, imageItem.imageData);

                // Clean up object URL
                URL.revokeObjectURL(img.src);
            }

            displayImageData(canvas, imageData) {
                const ctx = canvas.getContext('2d');
                canvas.width = imageData.width;
                canvas.height = imageData.height;
                ctx.putImageData(imageData, 0, 0);
            }

            updateImageProgress(index, percent) {
                if (index >= 0 && index < this.images.length) {
                    const imageItem = this.images[index];
                    imageItem.status.textContent = `Processing... ${percent.toFixed(1)}%`;
                }
            }

            cancelProcessing() {
                if (this.isProcessing) {
                    this.isProcessing = false;
                    this.worker.terminate();
                    this.worker = new Worker('batch-processor-worker.js');
                    this.worker.onmessage = (event) => this.handleWorkerMessage(event);
                    this.worker.onerror = (error) => {
                        console.error('Worker error:', error);
                    };
                    this.updateStatus('Processing cancelled by user.');
                    this.finishProcessing();
                }
            }

            finishProcessing() {
                this.isProcessing = false;
                this.processBtn.disabled = false;
                this.cancelBtn.disabled = true;
                this.progress.style.display = 'none';

                const successRate = this.stats.total > 0 ? ((this.stats.success / this.stats.total) * 100).toFixed(1) : 0;
                this.updateStatus(`Batch processing completed! Success rate: ${successRate}%`);
            }

            clearAll() {
                this.images = [];
                this.imageGrid.innerHTML = '';
                this.statsContainer.style.display = 'none';
                this.processBtn.disabled = true;
                this.cancelBtn.disabled = true;
                this.clearBtn.disabled = true;
                this.progress.style.display = 'none';
                this.resetStats();
                this.updateStatus('All images cleared. Ready to load new images.');
            }

            resetStats() {
                this.stats = { total: 0, processed: 0, success: 0, error: 0 };
                this.updateStats();
            }

            updateStats() {
                this.stats.total = this.images.length;
                document.getElementById('totalImages').textContent = this.stats.total;
                document.getElementById('processedImages').textContent = this.stats.processed;
                document.getElementById('successCount').textContent = this.stats.success;
                document.getElementById('errorCount').textContent = this.stats.error;
            }

            updateOverallProgress(percent) {
                this.progressBar.style.width = percent + '%';
            }

            updateStatus(message) {
                this.status.textContent = message;
            }

            cleanup() {
                if (this.worker) {
                    this.worker.terminate();
                }
            }
        }

        // Initialize batch processor when page loads
        let processor;
        window.addEventListener('load', () => {
            processor = new BatchProcessor();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (processor) {
                processor.cleanup();
            }
        });
    </script>
</body>
</html>